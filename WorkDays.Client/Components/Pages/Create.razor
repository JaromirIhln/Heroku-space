@page "/create"
@using WorkDays.Client.Models
@inject HttpClient Http
@inject NavigationManager Navigation


<h3 class="fa fa-add icon-color-primary"> Přidat den</h3>

<EditForm Model="workDay" OnValidSubmit="HandleValidSubmit">
	<DataAnnotationsValidator />
	<ValidationSummary />
	<div class="mb-2">
		<label>Datum:</label>
		<InputDate @bind-Value="workDay.Date" class="form-control" />
	</div>
	<div class="mb-2">
		<label>Začátek:</label>
		<InputText @bind-Value="startTimeString" class="form-control" placeholder="HH:mm" />
	</div>
	<div class="mb-2">
		<label>Konec:</label>
		<InputText @bind-Value="endTimeString" class="form-control" placeholder="HH:mm" />
	</div>
	<div class="mb-2">
		<label>Přestávka:</label>
		<InputText @bind-Value="breakString" class="form-control" placeholder="HH:mm" />
	</div>
	<div class="mb-2">
		<label>Typ:</label>
		<InputSelect @bind-Value="workDay.Type" class="form-control">
			@foreach (var type in Enum.GetValues<DayType>())
			{
				<option value="@type">@type</option>
			}
		</InputSelect>
	</div>
	<div class="mb-2">
		<label>Je svátek:</label>
		<InputCheckbox @bind-Value="workDay.IsHoliday" />
	</div>
	<button type="submit" class="btn btn-primary">Uložit</button>
</EditForm>

@if (!string.IsNullOrEmpty(message))
{
	<div class="alert alert-info">@message</div>
}

@code {
	private WorkDayDto workDay = new WorkDayDto { Date = DateTime.Today };
	private string? startTimeString;
	private string? endTimeString;
	private string? breakString;
	private string? message;

	private async Task HandleValidSubmit()
	{
		try
		{
			workDay.StartTime = TimeOnly.Parse(startTimeString ?? "00:00");
			workDay.EndTime = TimeOnly.Parse(endTimeString ?? "00:00");
			workDay.Break = TimeOnly.Parse(breakString ?? "00:00");
			// TotalHours a další výpočty lze dopočítat na serveru
			var response = await Http.PostAsJsonAsync("api/workday", workDay);
			if (response.IsSuccessStatusCode)
			{
				message = "Pracovní den byl úspěšně přidán.";
				workDay = new WorkDayDto { Date = DateTime.Today };
				startTimeString = endTimeString = breakString = null;
				Navigation.NavigateTo("/");
			}
			else
			{
				message = "Chyba při ukládání: " + response.ReasonPhrase;
			}
		}
		catch (Exception ex)
		{
			message = $"Chyba: {ex.GetType().Name} - {ex.Message}";
		}
	}
}

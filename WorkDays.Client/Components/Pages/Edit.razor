@page "/edit/{Id:int}"
@using WorkDays.Client.Models
@inject HttpClient Http
@inject NavigationManager Navigation

<h3>Editace pracovního dne</h3>

@if (isLoading)
{
	<p>Načítám...</p>
}
else if (workDay == null)
{
	<div class="alert alert-danger">Záznam nenalezen.</div>
}
else
{
	<EditForm Model="workDay" OnValidSubmit="HandleValidSubmit">
		<DataAnnotationsValidator />
		<ValidationSummary />
		<div class="mb-2">
			<label>Datum:</label>
			<InputDate @bind-Value="workDay.Date" class="form-control" />
		</div>
		<div class="mb-2">
			<label>Začátek:</label>
			<InputText @bind-Value="startTimeString" class="form-control" placeholder="HH:mm" />
		</div>
		<div class="mb-2">
			<label>Konec:</label>
			<InputText @bind-Value="endTimeString" class="form-control" placeholder="HH:mm" />
		</div>
		<div class="mb-2">
			<label>Přestávka:</label>
			<InputText @bind-Value="breakString" class="form-control" placeholder="HH:mm" />
		</div>
		<div class="mb-2">
			<label>Typ:</label>
			<InputSelect @bind-Value="workDay.Type" class="form-control">
				@foreach (var type in Enum.GetValues<DayType>())
				{
					<option value="@type">@type</option>
				}
			</InputSelect>
		</div>
		<div class="mb-2">
			<label>Je svátek:</label>
			<InputCheckbox @bind-Value="workDay.IsHoliday" />
		</div>
		<button type="submit" class="btn btn-primary">Uložit změny</button>
		<button type="submit" class="btn btn-secondary" href="/">Zpět</button>
	</EditForm>
	@if (!string.IsNullOrEmpty(message))
	{
		<div class="alert alert-info">@message</div>
	}
}

@code {
	[Parameter]
	public int Id { get; set; }

	private WorkDayDto? workDay;
	private string? startTimeString;
	private string? endTimeString;
	private string? breakString;
	private string? message;
	private bool isLoading = true;

	protected override async Task OnInitializedAsync()
	{
		try
		{
			workDay = await Http.GetFromJsonAsync<WorkDayDto>($"api/workday/{Id}");
			if (workDay != null)
			{
				startTimeString = workDay.StartTime.ToString("HH:mm");
				endTimeString = workDay.EndTime.ToString("HH:mm");
				breakString = workDay.Break.ToString("HH:mm");
			}
		}
		catch
		{
			workDay = null;
		}
		isLoading = false;
	}

	private async Task HandleValidSubmit()
	{
		try
		{
			if (workDay == null) return;
			workDay.StartTime = TimeOnly.Parse(startTimeString ?? "00:00");
			workDay.EndTime = TimeOnly.Parse(endTimeString ?? "00:00");
			workDay.Break = TimeOnly.Parse(breakString ?? "00:00");
			var response = await Http.PutAsJsonAsync($"api/workday/{Id}", workDay);
			if (response.IsSuccessStatusCode)
			{
				message = "Změny byly uloženy.";
				Navigation.NavigateTo($"/detail/{Id}");
			}
			else
			{
				message = "Chyba při ukládání: " + response.ReasonPhrase;
			}
		}
		catch (Exception ex)
		{
			message = $"Chyba: {ex.Message}";
		}
	}
}
